# Client Attestation for OAuth 2.0

[Webauthn]

## Introduction

This spec allows defines a way for implementing a Confidential Native Client
by utilising secure enclaves of the Native Client. 


We extend the OAuth Dynamic Client Registration to support for attesting
that the Native Client has access to said key and prove cryptographically that the
key is deviced-backed prior to succesful registration by defining a `software_statement_type`.


Furthermore we define a new `client_assertion_type` to allow Confidential Native Clients to
authenticate to the Oauth Token Endpoint [citation needed] using a device backed
key by presenting a Webauthn Assertion.

This spec reuses the attestation and assertion formats of the [webauhtn][webauthn] standard.

## Client Registration

### Webauthn Assertion Metadata Value

For Webauthn Assertions this specification defines and registers the
following authentication method metadata value into the ["Oauth Token Endpoint Authentication Methods"][IANA.OAuth.Parameters] registry.

`private_key_webauthn`. When this value is set in the client registration data
the client MUST use the `client_assertion_type`  `urn:ietf:params:oauth:client-assertion-type:webauthn-attestation` and the `client_assertion` MUST be a webauthn attestation token  issued by the authorization
server during client registration.

We define a new value for `client_assertion_type`.
`urn:ietf:params:oauth:client-assertion-type:webauthn-attestation`

### Client Registration Endpoint

### Fetching the attestation challenge

TODO??

In order to register a client using an attestation statement, we need
to fetch a cryptographic challenge to ansure the attestation statement is fresh.

### Solving the challenge

If the attestation object solves the challenge succesfully, the registration endpoint
will return a JWT stating that the attestation is valid. This JWT will
be used by the client together with an assertion of the private key when calling the Token Endpoint to authenticate against the authorisation server.

The following fields can  be in the JWT:

the `typ` is set to `jwt+attest`

* `iat` The time at which the attestation was performed
* `nbf` The time from which the attestation should be considered valid.
* `exp` The duration for which the attestation should be considered valid.
* `sub` a unique identifier for this attestation. this MUST be set to the client_id
* `cnf.cwk` is set to the base64urlencoded COSE_KEY Encoding of `credentialPublicKey` (Which is in COSE format).  OPTIONAL
* `cnf.jwk` is set to the JWK encoding of the `credentialPublicKey`. OPTIONAL


## Webauthn Attestation Statement

The `webauthn_attestation_statement` serves a similar purpose to the
`software_statement`. Unlike the `software_statement` it is generated by the
client on demand.


## Challenge endpoint
### Challenge Request

```
POST /challenge HTTP/1.1
Accept: application/json
```


### Challenge response

```
Content-Type: "application/json"
Cache: no-store
Pragma: no-cache
Location: /challenge/:id

{
    "challenge": "chal"
}
```


## Client Registration Request



```
POST /register HTTP/1.1
Content-Type: application/json
Accept: application/json
Host: server.example.com


{
    "webauthn_attestation_statement":  {
        "client_data_json": base64urlencode({
            "type": "webauthn.create",
            "origin": "<software_id>:<software_version>",
            "challenge": <challenge>,

            "redirect_uris": [ "com.example.myapp://redirect-uri" ],
            "client_name": "My app",
            "token_endpoint_auth_method": "private_key_webauthn",
            "grant_types": [ "authorization_code", "refresh_token" ],
            "software_id": "com.example.myapp",
            "software_version: "3.0.1",
        }),
        "attestation_object": "",
    }
}
```

```
HTTP/1.1 201 Created
Content-Type: application/json
Cache-Control: no-store
Pragma: no-cache

{
    "client_id": "s6BhdRkqt3",
    "redirect_uris": [ "com.example.myapp://redirect-uri" ],
    "client_name": "My app",
    "token_endpoint_auth_method": "private_key_webauthn",
    "webauthn_attestion_token": "TODO NORMATIVE EXAMPLE",
    "grant_types": ["authorization_code", "refresh_token" ]

}
```

## Token Endpoint


```
POST /token HTTP/1.1
Content-Type: urlformendcoded


```

```
```


```
POST /token HTTP/1.1
Content-Type: urlformendcoded
client_assertion_type=urn%3Aietf%3Aparams%3Aoauth%3Aclient-assertion-type%3Awebauthn-attestation&
client_assertion=<WEB ATTESTATION TOKEN>


```


## References

### Normative References

[webauthn]: https://www.w3.org/TR/webauthn-2/ 'Web Authentication: An API for accessing Public Key Credentials Level 2'
[RFC7951]: https://www.rfc-editor.org/rfc/rfc7591.html 'RFC7951'
[IANA.OAuth.Parameters]: <https://www.iana.org/assignments/oauth-parameters> 'IANA, "OAuth Parameters",'
[OpenID.Registration]: http://openid.net/specs/openid-connect-registration-1_0.html 'Sakimura, N., Bradley, J., and M. Jones, "OpenID Connect Dynamic Client Registration 1.0", November 2014,'

https://www.rfc-editor.org/rfc/rfc7800.html